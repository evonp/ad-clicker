from playwright.sync_api import sync_playwright
import random
import time
from config import TARGET_URL, get_random_user_agent, get_random_viewport, should_bounce, AD_SELECTORS
from behavior_simulator import simulate_human_behavior

def find_clickable_elements(page):
    """æ™ºèƒ½æŸ¥æ‰¾å¯ç‚¹å‡»å…ƒç´ """
    # å°è¯•ä½¿ç”¨æ‚¨æä¾›çš„é€‰æ‹©å™¨
    selector = ", ".join(AD_SELECTORS)
    elements = page.query_selector_all(selector)
    
    if elements:
        print(f"ğŸ” Found {len(elements)} elements with custom selectors")
        return elements
    
    print("âš ï¸ Custom selectors not found, using fallback")
    
    # å¤‡ç”¨æ–¹æ¡ˆï¼šæŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®å’Œé“¾æ¥
    buttons = page.query_selector_all("button")
    links = page.query_selector_all("a")
    
    # æ·»åŠ æ›´å¤šå¯èƒ½çš„å…ƒç´ ç±»å‹
    divs = page.query_selector_all('div[onclick]')
    spans = page.query_selector_all('span[onclick]')
    
    all_elements = buttons + links + divs + spans
    
    if not all_elements:
        print("âš ï¸ No clickable elements found at all")
        
    return all_elements

def execute_click():
    print("ğŸš€ Starting click execution...")
    
    with sync_playwright() as p:
        # åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡
        browser = p.chromium.launch(headless=True)
        context = browser.new_context(
            user_agent=get_random_user_agent(),
            viewport=get_random_viewport(),
            proxy={"server": "socks5://127.0.0.1:40000"}
        )
        
        page = context.new_page()
        
        try:
            # è®¿é—®ç›®æ ‡é¡µé¢
            page.goto(TARGET_URL, timeout=60000, wait_until="domcontentloaded")
            print(f"ğŸŒ Loaded: {TARGET_URL}")
            
            # ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            page.wait_for_load_state("networkidle", timeout=15000)
            
            # æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º
            simulate_human_behavior(page)
            
            # å†³å®šæ˜¯å¦è·³å‡º
            if should_bounce():
                print("â†©ï¸ Simulating bounce (no click)")
                return False
            
            # å®šä½å¹¿å‘Šå…ƒç´ 
            ad_elements = find_clickable_elements(page)
            
            if not ad_elements:
                print("âš ï¸ No ad elements found")
                return False
                
            # éšæœºé€‰æ‹©ä¸€ä¸ªå¹¿å‘Šå…ƒç´ 
            ad = random.choice(ad_elements)
            print(f"ğŸ¯ Selected element: {ad.evaluate('el => el.outerHTML')[:100]}...")
            
            # ç¡®ä¿å…ƒç´ åœ¨è§†å›¾ä¸­
            ad.scroll_into_view_if_needed()
            
            # æ¨¡æ‹Ÿæ‚¬åœå’Œç‚¹å‡»
            ad.hover()
            time.sleep(random.uniform(0.5, 1.5))
            
            # ä½¿ç”¨JavaScriptç‚¹å‡»é¿å…æ£€æµ‹
            page.evaluate("element => element.click()", ad)
            
            # ç‚¹å‡»åè¡Œä¸º
            try:
                # ç­‰å¾…é¡µé¢å˜åŒ–
                page.wait_for_load_state("networkidle", timeout=5000)
                print("âœ… Click successful - page changed detected")
            except:
                print("âœ… Click executed - no page change detected")
                
            # éšæœºæµè§ˆæ—¶é—´
            time.sleep(random.uniform(2, 8))
            return True
            
        except Exception as e:
            print(f"âŒ Click failed: {str(e)}")
            return False
            
        finally:
            browser.close()