import os
import subprocess
import requests

def setup_warp_proxy():
    """å®‰è£…å¹¶é…ç½®WARPä»£ç†"""
    print("ğŸ”§ Setting up WARP proxy...")
    
    try:
        # å®‰è£…WARP
        commands = [
            "sudo apt-get update",
            "sudo apt-get install -y curl gpg",
            "curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg",
            'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list',
            "sudo apt-get update",
            "sudo apt-get install -y cloudflare-warp"
        ]
        
        for cmd in commands:
            subprocess.run(cmd, shell=True, check=True)
        
        # æ³¨å†Œå¹¶å¯åŠ¨WARP
        subprocess.run("warp-cli register", shell=True, check=True)
        subprocess.run("warp-cli set-mode proxy", shell=True, check=True)
        subprocess.run("warp-cli connect", shell=True, check=True)
        
        # éªŒè¯IP
        verify_ip()
        
    except Exception as e:
        print(f"âš ï¸ WARP setup failed: {e}")
        activate_backup_proxy()

def verify_ip():
    """éªŒè¯IPæ˜¯å¦ä¸ºç¾å›½IP"""
    print("ğŸŒ Verifying IP location...")
    try:
        response = requests.get("https://ipinfo.io/json", 
                               proxies={"https": "socks5://127.0.0.1:40000"},
                               timeout=10)
        data = response.json()
        country = data.get("country", "")
        print(f"Current IP: {data['ip']} | Country: {country}")
        
        if country != "US":
            raise Exception(f"IP is from {country}, not US")
    except Exception as e:
        print(f"âš ï¸ IP verification error: {e}")
        activate_backup_proxy()

def activate_backup_proxy():
    """æ¿€æ´»å¤‡ç”¨ä»£ç†æ–¹æ¡ˆ"""
    print("ğŸ›¡ï¸ Activating backup proxy...")
    try:
        # å°è¯•ä½¿ç”¨å…¬å…±ä»£ç†ä½œä¸ºå¤‡é€‰
        print("Using public proxy as fallback...")
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šå¤‡ç”¨ä»£ç†é€‰é¡¹
    except Exception as e:
        print(f"âš ï¸ Backup proxy failed: {e}")